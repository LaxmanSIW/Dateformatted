function main(workbook: ExcelScript.Workbook): string {

  // Convert points (Excel) to pixels (HTML)
  function ptToPx(pt: number) {
    return Math.round(pt * 1.3333);
  }

  const sheet = workbook.getWorksheet("Main");
  const usedRange = sheet.getUsedRange();
  if (!usedRange) return "No data found in sheet";

  // Get cell values (1 API call for entire range)
  const values = usedRange.getValues();
  const totalRows = values.length;
  const totalCols = values[0].length;

  const usedTopRow = usedRange.getRowIndex();
  const usedLeftCol = usedRange.getColumnIndex();

  // Row heights and column widths (1 call per row/column, unavoidable)
  const rowHeights = Array.from({ length: totalRows }, (_, r) => usedRange.getRow(r).getHeight());
  const colWidths = Array.from({ length: totalCols }, (_, c) => usedRange.getColumn(c).getWidth());

  // Fetch ALL formatting in a single sweep (Major optimization)
  const props = usedRange.getCellProperties({
    format: {
      horizontalAlignment: true,
      verticalAlignment: true,
      font: { bold: true, italic: true, underline: true, size: true, name: true, color: true },
      fill: { color: true },
      borders: {
        top: { style: true, color: true },
        bottom: { style: true, color: true },
        left: { style: true, color: true },
        right: { style: true, color: true },
      },
      wrapText: true
    }
  });

  // Detect merged cells and record spans
  const mergedMap = new Map<string, { rowSpan: number; colSpan: number; isTopLeft: boolean }>();
  const mergedAreas = usedRange.getMergedAreas()?.getAreas() ?? [];

  mergedAreas.forEach(range => {
    const r0 = range.getCell(0, 0).getRowIndex() - usedTopRow;
    const c0 = range.getCell(0, 0).getColumnIndex() - usedLeftCol;
    const rs = range.getRowCount();
    const cs = range.getColumnCount();

    for (let r = r0; r < r0 + rs; r++) {
      for (let c = c0; c < c0 + cs; c++) {
        mergedMap.set(`${r},${c}`, {
          rowSpan: rs,
          colSpan: cs,
          isTopLeft: (r === r0 && c === c0)
        });
      }
    }
  });

  // Begin building HTML output
  const html: string[] = [];
  html.push("<table border='0' cellspacing='0' cellpadding='0'>");

  for (let r = 0; r < totalRows; r++) {
    html.push(`<tr style="height:${ptToPx(rowHeights[r])}px">`);

    for (let c = 0; c < totalCols; c++) {

      const merge = mergedMap.get(`${r},${c}`);
      // Skip non-top-left cells of merged blocks
      if (merge && !merge.isTopLeft) continue;

      const p = props[r][c].format;
      const style: string[] = [];

      // Text styles
      if (p.font?.bold) style.push("font-weight:bold");
      if (p.font?.italic) style.push("font-style:italic");
      if (p.font?.underline !== ExcelScript.RangeUnderlineStyle.none) style.push("text-decoration:underline");
      if (p.font?.size) style.push(`font-size:${ptToPx(p.font.size)}px`);
      if (p.font?.name) style.push(`font-family:${p.font.name}`);
      if (p.font?.color) style.push(`color:${p.font.color}`);

      // Background fill
      if (p.fill?.color) style.push(`background-color:${p.fill.color}`);

      // Alignment (cast enum to string safely)
      if (p.horizontalAlignment) style.push(`text-align:${String(p.horizontalAlignment).toLowerCase()}`);
      if (p.verticalAlignment) style.push(`vertical-align:${String(p.verticalAlignment).toLowerCase()}`);

      // Wrap text
      if (p.wrapText) style.push("white-space:normal");

      // Set width
      style.push(`width:${ptToPx(colWidths[c])}px`);

      // Borders (check against enum)
      const b = p.borders;
      if (b?.top?.style !== ExcelScript.BorderLineStyle.none) style.push(`border-top:1px solid ${b.top.color}`);
      if (b?.right?.style !== ExcelScript.BorderLineStyle.none) style.push(`border-right:1px solid ${b.right.color}`);
      if (b?.bottom?.style !== ExcelScript.BorderLineStyle.none) style.push(`border-bottom:1px solid ${b.bottom.color}`);
      if (b?.left?.style !== ExcelScript.BorderLineStyle.none) style.push(`border-left:1px solid ${b.left.color}`);

      // Merge spans if present
      const span = merge ? ` rowspan="${merge.rowSpan}" colspan="${merge.colSpan}"` : "";

      html.push(`<td${span} style="${style.join(";")}">${values[r][c] ?? ""}</td>`);
    }

    html.push("</tr>");
  }

  html.push("</table>");
  return html.join("");
}
